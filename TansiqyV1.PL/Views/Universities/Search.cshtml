@model IEnumerable<TansiqyV1.BLL.ModelVM.UniversityViewModel>
@using TansiqyV1.PL.Helpers
@{
    ViewData["Title"] = "بحث مخصص لك";
}

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="mb-3 d-flex align-items-center gap-2">
        <a href="javascript:history.back()" class="text-decoration-none text-dark">
            <i class="fas fa-arrow-right me-2"></i> العودة
        </a>
        <span class="text-muted">|</span>
        <a href="@Url.Action("Index", "Home")" class="text-decoration-none text-dark">
            <i class="fas fa-home me-2"></i> الرئيسية
        </a>
    </div>

    <div class="mb-3">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="ابحث عن الكلية المناسبة لك باستخدام الفلاتر المتقدمة" id="searchInput">
            <button class="btn btn-outline-secondary" type="button">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>

    <div class="row">
        <!-- Filters Sidebar -->
        <div class="col-md-3 mb-4">
            <div class="filter-sidebar">
                <h5 class="mb-4">الفلاتر</h5>
                <form method="get" action="@Url.Action("Search")" id="searchForm">
                    <!-- اسم الجامعة -->
                    <div class="mb-4">
                        <label for="searchTerm" class="form-label fw-bold mb-3">اسم الجامعة</label>
                        <input type="text" class="form-control" id="searchTerm" name="searchTerm"
                               placeholder="ابحث عن اسم الجامعة..." value="@(ViewBag.SearchTerm ?? "")">
                    </div>

                    <!-- اسم الكلية -->
                    <div class="mb-4">
                        <label for="collegeName" class="form-label fw-bold mb-3">اسم الكلية</label>
                        <input type="text" class="form-control" id="collegeName" name="collegeName"
                               placeholder="ابحث عن اسم الكلية..." value="@(ViewBag.CollegeName ?? "")">
                    </div>

                    <!-- المحافظة -->
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-3">المحافظة</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="governorate" value="1" id="gov1" @(ViewBag.Governorate == 1 ? "checked" : "")>
                            <label class="form-check-label" for="gov1">القاهرة</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="governorate" value="2" id="gov2" @(ViewBag.Governorate == 2 ? "checked" : "")>
                            <label class="form-check-label" for="gov2">الإسكندرية</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="governorate" value="3" id="gov3" @(ViewBag.Governorate == 3 ? "checked" : "")>
                            <label class="form-check-label" for="gov3">الجيزة</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="governorate" value="5" id="gov5" @(ViewBag.Governorate == 5 ? "checked" : "")>
                            <label class="form-check-label" for="gov5">الدقهلية</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="governorate" value="4" id="gov4" @(ViewBag.Governorate == 4 ? "checked" : "")>
                            <label class="form-check-label" for="gov4">الشرقية</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="governorate" value="26" id="gov26" @(ViewBag.Governorate == 26 ? "checked" : "")>
                            <label class="form-check-label" for="gov26">السويس</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="governorate" value="14" id="gov14" @(ViewBag.Governorate == 14 ? "checked" : "")>
                            <label class="form-check-label" for="gov14">أسيوط</label>
                        </div>
                    </div>

                    <!-- المصاريف السنوية -->
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-3">المصاريف السنوية (حد أقصى)</label>
                        <input type="range" class="form-range" min="0" max="500000" step="1000" value="@(ViewBag.MaxFees ?? 300000)" id="feesRange" oninput="document.getElementById('feesValue').textContent = this.value + ' جنية'">
                        <div class="d-flex justify-content-between">
                            <small>0</small>
                            <small id="feesValue">@((ViewBag.MaxFees ?? 300000).ToString("N0")) جنية</small>
                            <small>500,000</small>
                        </div>
                        <input type="hidden" name="maxFees" id="maxFeesInput" value="@(ViewBag.MaxFees ?? 300000)">
                    </div>

                    <!-- التنسيق -->
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-3">التنسيق (حد أدنى)</label>
                        <input type="range" class="form-range" min="0" max="100" step="1" value="@(ViewBag.MinCoordination ?? 300)" id="coordinationRange" oninput="document.getElementById('coordinationValue').textContent = this.value + ' درجة'">
                        <div class="d-flex justify-content-between">
                            <small>0</small>
                            <small id="coordinationValue">@(ViewBag.MinCoordination ?? 300) درجة</small>
                            <small>100</small>
                        </div>
                        <input type="hidden" name="minCoordination" id="minCoordinationInput" value="@(ViewBag.MinCoordination ?? 300)">
                    </div>

                    <!-- الشعبة -->
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-3">الشعبة</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="studyType" value="2" id="study2" @(ViewBag.StudyType == 2 ? "checked" : "")>
                            <label class="form-check-label" for="study2">علمي علوم</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="studyType" value="1" id="study1" @(ViewBag.StudyType == 1 ? "checked" : "")>
                            <label class="form-check-label" for="study1">علمي رياضة</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="studyType" value="3" id="study3" @(ViewBag.StudyType == 3 ? "checked" : "")>
                            <label class="form-check-label" for="study3">أدبي</label>
                        </div>
                    </div>

                    <!-- مراحل التنسيق -->
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-3">مراحل التنسيق</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="stage" value="1" id="stage1">
                            <label class="form-check-label" for="stage1">مرحلة أولى</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="stage" value="2" id="stage2">
                            <label class="form-check-label" for="stage2">مرحلة ثانية</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="stage" value="3" id="stage3">
                            <label class="form-check-label" for="stage3">مرحلة ثالثة</label>
                        </div>
                    </div>

                    <!-- نوع الجامعة -->
                    <div class="mb-4">
                        <label class="form-label fw-bold mb-3">نوع الجامعة</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="type" value="1" id="type1" @(ViewBag.Type == 1 ? "checked" : "")>
                            <label class="form-check-label" for="type1">حكومية</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="type" value="2" id="type2" @(ViewBag.Type == 2 ? "checked" : "")>
                            <label class="form-check-label" for="type2">أهلية</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="type" value="6" id="type6" @(ViewBag.Type == 6 ? "checked" : "")>
                            <label class="form-check-label" for="type6">تكنولوجية</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="type" value="4" id="type4" @(ViewBag.Type == 4 ? "checked" : "")>
                            <label class="form-check-label" for="type4">معاهد عليا</label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">تطبيق الفلاتر</button>
                </form>
            </div>
        </div>

        <!-- Results -->
        <div class="col-md-9">
            <h4 class="mb-4">عدد النتائج @Model.Count() كليه</h4>

            @if (Model != null && Model.Any())
            {
                <div class="row g-3">
                    @foreach (var university in Model)
                    {
                        @foreach (var college in university.Colleges)
                        {
                            <div class="col-md-6">
                                <div class="college-card">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <span class="badge-type @(university.Type == (int)TansiqyV1.DAL.Enums.UniversityType.Governmental ? "badge-governmental" : university.Type == (int)TansiqyV1.DAL.Enums.UniversityType.Private ? "badge-private" : "badge-institute")">
                                            @EnumHelper.GetUniversityTypeName((TansiqyV1.DAL.Enums.UniversityType)university.Type)
                                        </span>
                                    </div>

                                    <h5 class="mb-2">@college.NameAr</h5>
                                    <p class="text-muted mb-2">
                                        <i class="fas fa-university me-2"></i>@university.NameAr
                                    </p>

                                    @if (college.Departments != null && college.Departments.Any())
                                    {
                                        <p class="text-muted mb-2">
                                            <i class="fas fa-graduation-cap me-2"></i>@college.Departments.First().NameAr
                                        </p>
                                    }

                                    <p class="text-muted mb-2">
                                        <i class="fas fa-map-marker-alt me-2"></i>المحافظة @EnumHelper.GetGovernorateName((TansiqyV1.DAL.Enums.Governorate)university.Governorate)
                                    </p>

                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        @if (college.Fees.HasValue)
                                        {
                                            <span><i class="fas fa-money-bill-wave me-2"></i>@college.Fees.Value.ToString("N0") جنية</span>
                                        }
                                        else if (university.Type == (int)TansiqyV1.DAL.Enums.UniversityType.Governmental)
                                        {
                                            <span><i class="fas fa-money-bill-wave me-2"></i>مجاني</span>
                                        }

                                        @if (college.LastYearCoordination.HasValue)
                                        {
                                            <span><i class="fas fa-percentage me-2"></i>@college.LastYearCoordination.Value درجة</span>
                                        }
                                    </div>

                                    <span class="badge bg-info">مرحلة أولى</span>

                                    <div class="mt-3">
                                        <a href="@Url.Action("CollegeDetails", "Universities", new { id = college.Id })" class="btn btn-primary btn-sm">
                                            عرض التفاصيل
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            }
            else
            {
                <div class="alert alert-warning text-center">
                    <h4>لا توجد نتائج</h4>
                    <p>لم يتم العثور على أي كليات تطابق معايير البحث.</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('feesRange').addEventListener('input', function() {
            document.getElementById('feesValue').textContent = parseInt(this.value).toLocaleString() + ' جنية';
            document.getElementById('maxFeesInput').value = this.value;
        });

        document.getElementById('coordinationRange').addEventListener('input', function() {
            document.getElementById('coordinationValue').textContent = this.value + ' درجة';
            document.getElementById('minCoordinationInput').value = this.value;
        });
    </script>
}
